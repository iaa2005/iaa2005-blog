---
file: BL20220702
date: 2022-07-02
title: Спектроскопия шарового скопления NGC 7006
tags: astronomy python
---

Данные для работы: [на Dropbox](https://www.dropbox.com/s/qcr56l3jseu1f81/lab5_data.zip?dl=0)

# Введение
В этой лаборатории мы проведем вас через чтение, построение графиков и подгонку спектров звезд 
в шаровом скоплении Млечного Пути. Научная цель состоит в том, чтобы определить скорость и 
ошибки скорости для нескольких звезд, чтобы определить, являются ли они членами шарового скопления 
или звездами переднего плана в Млечном Пути. Цель кодирования состоит в том, чтобы применить как 
методы подгонки $\chi^2$, так и методы подгонки MCMC, когда модель более сложная.

# Цели этой лаборатории:
1. Изучение поддерживаемого программного пакета (pypeit).
2. Чтение сложного файла fits и построение спектра.
3. Поиск параметров и ошибок с помощью подгонки $\chi^2$, когда модель не является аналитической 
   функцией
4. Поиск параметров и ошибок с помощью MCMC.
5. Подгонка многочленов к двумерным поверхностям, угловые графики.

# 1. Данные Кека ДЕЙМОСА

Мы будем работать с данными прибора ДЕЙМОС телескопа Кека. Все данные Keck находятся в открытом 
доступе на веб-сайте Keck Data Archive (KOA). Хотя мы не будем непосредственно сокращать исходные данные, 
давайте взглянем на эти файлы, чтобы получить представление о том, как выглядят данные. Мы выбрали 
данные из шарового скопления Млечного Пути NGC 7006.

Перейдите на веб-сайт KOA 
([https://koa.ipac.caltech.edu/cgi-bin/KOA/nph-KOAlogin](https://koa.ipac.caltech.edu/cgi-bin/KOA/nph-KOAlogin)) 
и найдите все файлы, 
снятые с ДЕЙМОСА в ночь на 3 июня 2011 года (20110603). Найдите в списке файлы с <red>Target Name == n7006</red> 
и изображением или <red>Dispersion == mos</red>. Найдите столбец с именем Quicklook Previews и нажмите на [Raw]. 
Это единичная экспозиция спектроскопической маски, центрированной на NGC 7006. На этом изображении вы должны 
увидеть около сотни спектров.

[Ссылка](https://koa.ipac.caltech.edu/cgi-bin/bgServices/nph-bgMonitor?bgstatusfile=/work/TMP_a98lLh_52567/bgServices/52567/status.txt&bgresultfile=/work/TMP_a98lLh_52567/bgServices/52567/return.html&bgresulturl=http://koa.ipac.caltech.edu/cgi-bin/sendFile/nph-sendFile?ref=/TMP_a98lLh_52567/bgServices/52567/return.html&appstatusparam=/work/TMP_a98lLh_52567/bgServices/52567/appstatusparam.txt&addrfile=/work/TMP_a98lLh_52567/bgServices/52567/addrfile.txt&frommail=koa-ops@ipac.caltech.edu&helpdesk=http://koa.ipac.caltech.edu/applications/Helpdesk&ws=/work/TMP_a98lLh_52567/bgServices/52567&childpid=52568) 
на найденые файлы на сайте koa.ipac.caltech.edu.

И само [изображение](https://koa.ipac.caltech.edu/workspace/TMP_cmx64p_47296/KOA//DE.20110603.45055.jpg) в высоком качестве с сайта.

Мы можем видеть ниже, что изображение файла имеет несколько спектров (по горизонтали) в небольших 
участках детектора (по вертикали). Вертикальные линии — это линии горизонта, присутствующие на определенных 
длинах волн по ширине щели. Обратите внимание, что наклон этих линий также варьируется в зависимости от детектора… 
еще одна проблема, требующая сокращения.

![image](https://koa.ipac.caltech.edu/workspace/TMP_cmx64p_47296/KOA//DE.20110603.45055.jpg)

# 2. Спектральные сжатия с помощью PypeIt
Используя файлы raw, загруженные из KOA выше, я запустил научные и калибровочные кадры с помощью пакета программного 
обеспечения для уменьшения спектра под названием <red>PypeIt</red>: [https://pypeit.readthedocs.io/en/release/](https://pypeit.readthedocs.io/en/release/). 
Репозиторий <red>PypeIt</red> github можно найти здесь: [https://github.com/pypeit/PypeIt](https://github.com/pypeit/PypeIt)

В каталоге доступа к данным мы предоставили выходной файл PypeIt, который содержит одномерные спектры для всех звезд, 
наблюдаемых в маске ДЕЙМОСА <red>n7006a</red>, которую вы просматривали выше. Считайте файл с помощью команд astropy.io.fits и 
просматривайте содержимое с помощью <red>hdu.info()</red>. Укажите, сколько спектров содержится в этом файле.

```python
from astropy.io import fits
import numpy as np

import matplotlib.pyplot as plt
%matplotlib inline

file = 'spec1d_DE.20110603.45055-n7006a_DEIMOS_2011Jun03T123053.021.fits'
```

```python
# Код для просмотра содержимого файла
hdu = fits.open(file)
hdu.info()
```

Вывод:

```txt
Filename: spec1d_DE.20110603.45055-n7006a_DEIMOS_2011Jun03T123053.021.fits
No.    Name      Ver    Type      Cards   Dimensions   Format
  0  PRIMARY       1 PrimaryHDU     231   ()      
  1  SPAT0494-SLIT0507-DET01    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
  2  SPAT0589-SLIT0577-DET01    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
  3  SPAT0642-SLIT0717-DET01    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
  4  SPAT0716-SLIT0717-DET01    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
  5  SPAT1002-SLIT0946-DET01    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
  6  SPAT1141-SLIT1128-DET01    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
  7  SPAT1230-SLIT1226-DET01    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
  8  SPAT1306-SLIT1337-DET01    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
  9  SPAT1513-SLIT1485-DET01    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 10  SPAT1613-SLIT1596-DET01    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 11  SPAT1653-SLIT1669-DET01    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 12  SPAT1849-SLIT1817-DET01    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 13  SPAT1955-SLIT1967-DET01    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 14  SPAT0010-SLIT0018-DET02    1 BinTableHDU     63   4096R x 12C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 15  SPAT0058-SLIT0062-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 16  SPAT0150-SLIT0148-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 17  SPAT0191-SLIT0189-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 18  SPAT0237-SLIT0232-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 19  SPAT0274-SLIT0273-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 20  SPAT0316-SLIT0312-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 21  SPAT0352-SLIT0353-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 22  SPAT0403-SLIT0397-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 23  SPAT0437-SLIT0438-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 24  SPAT0485-SLIT0481-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 25  SPAT0526-SLIT0524-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 26  SPAT0572-SLIT0567-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 27  SPAT0610-SLIT0607-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 28  SPAT0648-SLIT0645-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 29  SPAT0687-SLIT0685-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 30  SPAT0732-SLIT0726-DET02    1 BinTableHDU     42   4096R x 2C   [1D, 1K]   
 31  SPAT0768-SLIT0766-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 32  SPAT0810-SLIT0807-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 33  SPAT0853-SLIT0849-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 34  SPAT0893-SLIT0889-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 35  SPAT0928-SLIT0929-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 36  SPAT0978-SLIT0973-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 37  SPAT1018-SLIT1020-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 38  SPAT1076-SLIT1069-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 39  SPAT1115-SLIT1116-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 40  SPAT1170-SLIT1168-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 41  SPAT1227-SLIT1224-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 42  SPAT1283-SLIT1283-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 43  SPAT1351-SLIT1342-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 44  SPAT1395-SLIT1391-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 45  SPAT1435-SLIT1431-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 46  SPAT1471-SLIT1469-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 47  SPAT1509-SLIT1508-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 48  SPAT1551-SLIT1547-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 49  SPAT1590-SLIT1589-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 50  SPAT1638-SLIT1631-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 51  SPAT1671-SLIT1670-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 52  SPAT1713-SLIT1711-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 53  SPAT1762-SLIT1763-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 54  SPAT1828-SLIT1825-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 55  SPAT1894-SLIT1884-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 56  SPAT1933-SLIT1959-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 57  SPAT1991-SLIT1959-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 58  SPAT2028-SLIT2026-DET02    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 59  SPAT0033-SLIT0037-DET03    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 60  SPAT0113-SLIT0102-DET03    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 61  SPAT0161-SLIT0163-DET03    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 62  SPAT0225-SLIT0223-DET03    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 63  SPAT0291-SLIT0304-DET03    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 64  SPAT0420-SLIT0413-DET03    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 65  SPAT0532-SLIT0511-DET03    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 66  SPAT0573-SLIT0577-DET03    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 67  SPAT0643-SLIT0651-DET03    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 68  SPAT0757-SLIT0739-DET03    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 69  SPAT0809-SLIT0804-DET03    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 70  SPAT0852-SLIT0856-DET03    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 71  SPAT0922-SLIT0932-DET03    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 72  SPAT1023-SLIT1031-DET03    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 73  SPAT1042-SLIT1031-DET03    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 74  SPAT1126-SLIT1113-DET03    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 75  SPAT1169-SLIT1186-DET03    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 76  SPAT1292-SLIT1279-DET03    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 77  SPAT1375-SLIT1375-DET03    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 78  SPAT1467-SLIT1481-DET03    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 79  SPAT1624-SLIT1603-DET03    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 80  SPAT1705-SLIT1698-DET03    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 81  SPAT1768-SLIT1780-DET03    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 82  SPAT1890-SLIT1905-DET03    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 83  SPAT0054-SLIT0140-DET04    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 84  SPAT0168-SLIT0140-DET04    1 BinTableHDU     42   4096R x 2C   [1D, 1K]   
 85  SPAT0181-SLIT0140-DET04    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 86  SPAT0306-SLIT0303-DET04    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 87  SPAT0429-SLIT0423-DET04    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 88  SPAT0555-SLIT0560-DET04    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 89  SPAT0651-SLIT0643-DET04    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 90  SPAT0728-SLIT0725-DET04    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 91  SPAT0804-SLIT0791-DET04    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 92  SPAT1037-SLIT1057-DET04    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 93  SPAT1172-SLIT1150-DET04    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 94  SPAT1229-SLIT1305-DET04    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 95  SPAT1576-SLIT1517-DET04    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 96  SPAT1604-SLIT1517-DET04    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 97  SPAT0485-SLIT0498-DET05    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 98  SPAT0580-SLIT0569-DET05    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
 99  SPAT0633-SLIT0709-DET05    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
100  SPAT0994-SLIT0938-DET05    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
101  SPAT1133-SLIT1120-DET05    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
102  SPAT1222-SLIT1219-DET05    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
103  SPAT1299-SLIT1330-DET05    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
104  SPAT1505-SLIT1478-DET05    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
105  SPAT1606-SLIT1589-DET05    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
106  SPAT1646-SLIT1662-DET05    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
107  SPAT1842-SLIT1810-DET05    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
108  SPAT1948-SLIT1961-DET05    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
109  SPAT2038-SLIT2023-DET05    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
110  SPAT0050-SLIT0055-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
111  SPAT0142-SLIT0141-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
112  SPAT0183-SLIT0182-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
113  SPAT0229-SLIT0225-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
114  SPAT0266-SLIT0265-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
115  SPAT0309-SLIT0305-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
116  SPAT0345-SLIT0347-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
117  SPAT0395-SLIT0389-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
118  SPAT0430-SLIT0431-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
119  SPAT0477-SLIT0474-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
120  SPAT0519-SLIT0517-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
121  SPAT0564-SLIT0560-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
122  SPAT0603-SLIT0600-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
123  SPAT0641-SLIT0639-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
124  SPAT0679-SLIT0679-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
125  SPAT0725-SLIT0720-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
126  SPAT0761-SLIT0760-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
127  SPAT0803-SLIT0800-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
128  SPAT0846-SLIT0843-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
129  SPAT0883-SLIT0882-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
130  SPAT0922-SLIT0923-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
131  SPAT0971-SLIT0967-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
132  SPAT1014-SLIT1014-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
133  SPAT1070-SLIT1063-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
134  SPAT1109-SLIT1110-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
135  SPAT1163-SLIT1162-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
136  SPAT1221-SLIT1218-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
137  SPAT1277-SLIT1277-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
138  SPAT1344-SLIT1336-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
139  SPAT1389-SLIT1386-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
140  SPAT1429-SLIT1426-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
141  SPAT1465-SLIT1464-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
142  SPAT1504-SLIT1502-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
143  SPAT1545-SLIT1542-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
144  SPAT1584-SLIT1584-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
145  SPAT1632-SLIT1626-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
146  SPAT1665-SLIT1665-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
147  SPAT1707-SLIT1706-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
148  SPAT1756-SLIT1757-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
149  SPAT1822-SLIT1820-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
150  SPAT1888-SLIT1879-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
151  SPAT1928-SLIT1954-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
152  SPAT1985-SLIT1954-DET06    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
153  SPAT0029-SLIT0035-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
154  SPAT0110-SLIT0100-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
155  SPAT0158-SLIT0160-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
156  SPAT0222-SLIT0221-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
157  SPAT0288-SLIT0302-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
158  SPAT0417-SLIT0411-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
159  SPAT0530-SLIT0509-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
160  SPAT0570-SLIT0575-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
161  SPAT0640-SLIT0649-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
162  SPAT0755-SLIT0738-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
163  SPAT0807-SLIT0803-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
164  SPAT0850-SLIT0854-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
165  SPAT0920-SLIT0930-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
166  SPAT1021-SLIT1029-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
167  SPAT1040-SLIT1029-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
168  SPAT1124-SLIT1112-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
169  SPAT1167-SLIT1185-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
170  SPAT1241-SLIT1278-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
171  SPAT1291-SLIT1278-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
172  SPAT1373-SLIT1374-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
173  SPAT1466-SLIT1480-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
174  SPAT1466-SLIT1480-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
175  SPAT1623-SLIT1602-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
176  SPAT1704-SLIT1697-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
177  SPAT1767-SLIT1780-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
178  SPAT1889-SLIT1905-DET07    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
179  SPAT0164-SLIT0137-DET08    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
180  SPAT0177-SLIT0137-DET08    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
181  SPAT0302-SLIT0300-DET08    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
182  SPAT0425-SLIT0420-DET08    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
183  SPAT0551-SLIT0557-DET08    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
184  SPAT0648-SLIT0641-DET08    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
185  SPAT0725-SLIT0722-DET08    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
186  SPAT0800-SLIT0788-DET08    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
187  SPAT1034-SLIT1055-DET08    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
188  SPAT1168-SLIT1148-DET08    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
189  SPAT1225-SLIT1303-DET08    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
190  SPAT1574-SLIT1515-DET08    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
191  SPAT1601-SLIT1515-DET08    1 BinTableHDU     83   4096R x 22C   [1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1D, 1L, 1D, 1D, 1K]   
192  DET01-DETECTOR    1 BinTableHDU     34   1R x 2C   [1D, 1D]   
193  DET02-DETECTOR    1 BinTableHDU     34   1R x 2C   [1D, 1D]   
194  DET03-DETECTOR    1 BinTableHDU     34   1R x 2C   [1D, 1D]   
195  DET04-DETECTOR    1 BinTableHDU     34   1R x 2C   [1D, 1D]   
196  DET05-DETECTOR    1 BinTableHDU     34   1R x 2C   [1D, 1D]   
197  DET06-DETECTOR    1 BinTableHDU     34   1R x 2C   [1D, 1D]   
198  DET07-DETECTOR    1 BinTableHDU     34   1R x 2C   [1D, 1D]   
199  DET08-DETECTOR    1 BinTableHDU     34   1R x 2C   [1D, 1D]   
```

# Сколько спектров содержится в этом файле?
В этом файле fits содержится 191 отдельный спектр.

# 3. Построение выходных спектров 1D PypeIt и подгонка на глаз
Я выбрал 3 спектра из этого файла, которые являются звездами с высоким отношением сигнал/шум. 
Из таблицы соответствия, которую вы прочитали, выберите добавочный номер 121, 135 и 157. Их также можно выбрать, 
используя имена ‘SPAT0564-SLIT0560-DET06’, ‘SPAT1163-SLIT1162-DET06’ и ‘SPAT0288-SLIT0302-DET07’. Сохраните данные 
для каждого спектра отдельно.

Постройте график зависимости длины волны от количества/потока для каждой звезды. Пожалуйста, используйте оптимальные 
результаты извлечения (‘OPT_’). *Если вам нужны дополнительные указания относительно того, что находится в этом файле, 
обратитесь к документации PypeIt по файлам spec1d_*: 
[https://pypeit.readthedocs.io/en/release/out_spec1D.html](https://pypeit.readthedocs.io/en/release/out_spec1D.html)

```python
# Для каждой из этих трех звезд постройте график зависимости длины волны от количества.
# Используйте ylim = 8300-8800 Ангстрем
star_id = [121,  135,  157]

for id in star_id:

    fig,ax = plt.subplots(figsize=(15,3))
    data = hdu[id].data

    plt.plot(data['OPT_WAVE'],data['OPT_COUNTS'])
    plt.title('Star ID: {}'.format(id))
    plt.xlim(8300,8850)
    plt.xlabel('Wavelength (Ang)')
    plt.ylabel('Counts')
```

![image](https://astro-330.github.io/_images/Lab5_solutions_16_0.png)
![image](https://astro-330.github.io/_images/Lab5_solutions_16_1.png)
![image](https://astro-330.github.io/_images/Lab5_solutions_16_2.png)

# Экстра (+0,5)

Чтобы получить представление о скорости каждой звезды, вы можете попробовать измерить приблизительную 
скорость ‘на глаз’. Три самые сильные линии в приведенных выше спектрах принадлежат Кальцию II (CaII): 
8500.36, 8544.44, 8664.52 А (ангстрем). Какую скорость вы оцениваете?

```python
fig, axs = plt.subplots(3, 1,figsize=(15,10))

# ПРИМЕРНО УГАДАЙТЕ СКОРОСТЬ (км / с) - СДЕЛАНО ЗДЕСЬ НА ГЛАЗ
v_guess  = [-410,-400,-50]

ca_lines = [ 8500.36, 8544.44, 8664.52]

for id,v,ax in zip(star_id, v_guess, axs):
    data = hdu[id].data

    ax.plot(data['OPT_WAVE'],data['OPT_COUNTS'])
    ax.set_title('Star ID: {}'.format(id))
    ax.set_xlim(8460,8700)
    ax.set_xlabel('Wavelength (Ang)')
    ax.set_ylabel('Counts')
    
    for cl in ca_lines:
        ca_guess = cl * (1.+ v/2.99e5)
        ax.axvline(ca_guess,c='r')
```

![image](https://astro-330.github.io/_images/Lab5_solutions_18_0.png)

Итак, теперь мы знаем, что скорости, на которые мы рассчитываем (для трех звезд), находятся примерно в 
диапазоне -410, -400 и -50 км/с соответственно.

# 4. Спектры синтетической модели

В ASTR 255 и дополнительном вопросе выше вы измерили скорость звезды, измерив центр известной линии 
поглощения (либо на глаз, либо с помощью гауссова) и сравнив ее с длиной волны покоя. Хотя этот процесс 
действительно оценивает скорость звезды, он тратит впустую большую часть информации, присутствующей в полном спектре. 
Чтобы определить более точные скорости, мы обращаемся к “подгонке шаблона”, где спектр с известной скоростью 
сравнивается с нашим неизвестным научным спектром. Шаблонный спектр может быть либо эмпирическим 
(наблюдаемый спектр стандартной звезды, где скорость уже известна), либо синтетическим (численно вычисленным 
по звездным моделям). Здесь мы будем использовать синтетические шаблоны из библиотеки 
PHEONIX: [https://phoenix.astro.physik.uni-goettingen.de/](https://phoenix.astro.physik.uni-goettingen.de/)

```python
template_file = 'dmost_lte_5000_3.0_-2.0_.fits'
```

```python
def read_synthetic_spectrum(pfile):    
    '''
    Функция для загрузки файла синтетического шаблона в python с использованием длин 
    волн в вакууме
      
    Параметры
    ----------
    pfile: str
      путь к файлу synthetic fits для загрузки.
      
    Вывод функции (return)
    -------
    pwave: float array
      Длины волн синтетического спектра
    pflux: float array
      Поток синтетического спектра
    '''

    with fits.open(pfile) as hdu:
        data = hdu[1].data
        
    pflux = np.array(data['flux']).flatten()
    awave = np.exp((data['wave']).flatten())
    

    # CONVERTING AIR WAVELENGTHS TO VACUUM
    s = 10**4 / awave
    n = 1. + 0.00008336624212083 + \
            (0.02408926869968 / (130.1065924522 - s**2)) +\
            (0.0001599740894897 / (38.92568793293 - s**2))

    pwave = awave*n
    
    return pwave, pflux
```

```python
# Считаем в синтетических спектрах и построем график зависимости длины волны от потока
pwave, pflux = read_synthetic_spectrum(template_file)

fig,ax = plt.subplots(figsize=(15,4))
plt.plot(pwave,pflux)
plt.xlabel('Wavelength (Ang)')
plt.ylabel('Flux')
```

![image](https://astro-330.github.io/_images/Lab5_solutions_24_1.png)

# 5. Спектры синтетической модели – Сглаживание и подгонка континуума

Мы будем подгонять синтетический спектр к нашим научным данным с целью определения скорости нашего научного 
спектра. Синтетический спектр находится на нулевой скорости. Чтобы сопоставить научные данные, нам нужно (1) 
сгладить синтетический спектр до разрешения по длине волны, (2) сместить синтетический спектр со скоростью 
научных данных и (3) повторно настроить синтетический спектр и сопоставить уровни континуума.

## Сглаживание спектра

Сначала мы рассмотрим, как сгладить синтетический спектр, чтобы он соответствовал данным. Мы будем 
соответствовать этому значению ниже, но на данный момент давайте просто выберем число, основанное на оценке 
в один балл. Спектральные линии ДЕЙМОСА хорошо согласуются с гауссовым с $1-\sigma$ ширина линии, которая 
составляет примерно 0,5 ангстрема. Синтетические спектры имеют разрешение 0,02 ангстрема. Таким образом, 
нам нужно сгладить синтетические спектры с помощью гауссовского ядра, которое составляет 0,5 / 0,02 = 25 пикселей.

_Подсказка: у scipy есть функции, которые выполняют гауссову фильтрацию в 1D._

```python
# Напишите функцию для сглаживания синтетического спектра по Гауссу, используя ядро сглаживания
# в 25 пикселей.

import scipy.ndimage as scipynd

def smooth_spectrum(flux, sf):
    '''
    Сглаживание входного спектра с использованием гауссова ядра
    
    Параметры
    ----------
    flux: float array
        путь к файлу synthetic fits для загрузки. 
    lsf: float
        Функция разброса линий.  LSF используется в качестве ширины ядра сглаживания по Гауссу
       
    Возвращается
    -------
    smoothed_flux: float array
        Сглаженный входной массив
    '''
    
    smoothed_flux = scipynd.gaussian_filter 1d(flux, lsf, truncate=3)
    return smoothed_flux
```

## Подгонка континуума

Далее мы обратимся к вышеупомянутому шагу (3), общей форме и значению спектра, который мы будем называть ‘континуумом’. 
Давайте подгоним функцию к синтетическому спектру так, чтобы она была примерно такой же, как и научный спектр. 
Для участка спектра, с которым мы работаем, достаточно **линейной функции**. Чтобы сделать это, мы сначала перенастроим 
синтетический спектр по длине волны на тот же массив, что и данные.

Выберите научный спектр сверху и повторно настройте системный шаблон так, чтобы он использовал тот же массив 
длин волн (рассмотрите возможность использования <red>np.interp()</red>). Нам это нужно для выполнения 
точечной подгонки и сравнения между массивами.

Затем определите **линейную функцию** (mx+b), необходимую для сопоставления континуума синтетического спектра 
с континуумом научного. Фактическая “вещь”, которую мы хотим поместить в линию, — это функция отклика, 
разделение между научным спектром и синтетическим спектром. Поэтому, когда вы повторно привязываете свой 
синтетический спектр к длинам волн данных, вы затем разделяете и подгоняете полученное соотношение. Коэффициенты 
этой строки подскажут вам, как умножить синтетический спектр (который имеет единицы измерения, сильно 
отличающиеся от данных), чтобы получить приблизительное выравнивание континуумов.

```python
# Напишите функцию для повторной привязки синтетического шаблона к массиву длин волн данных и подгонки континуума.
def fit_continuum(pwave,pflux,data_wave,data_flux):
    '''
    Функция для загрузки файла синтетического шаблона в python с использованием вакуумных длин волн
        
    Параметры
    ----------
    pfile: str
        путь к файлу synthetic fits для загрузки. 
        
    Возвращается
    -------
    pwave: float array
        Длины волн синтетического спектра
    pflux: float array
        Поток синтетического спектра
    '''
        
    new_templ = np.interp(data_wave,pwave,pflux) # повторная привязка к данным
    
    # СОЗДАЙТЕ МАСКУ ДЛЯ ОТКЛОНЕНИЯ САМЫХ НИЗКИХ И САМЫХ ВЫСОКИХ ПИКСЕЛЕЙ
    tmp = data_flux/new_templ # это функция ответа
    msk = (tmp > np.percentile(tmp,20)) & (tmp < np.percentile(tmp,99)) # не подходит для самых отдаленных точек
    
    
    p  = np.polyfit(data_wave[msk],data_flux[msk]/new_templ[msk],1) # подходит
    pfit = np.poly1d(p)
    model = new_templ * pfit(data_wave)
    
    return model
```

В приведенном выше решении мы использовали <red>np.percentile</red> для создания маски, чтобы самые глубокие 
линии поглощения не сильно влияли на подгонку. Другой способ сделать это — использовать _interactive polyfit_, 
который выполняет несколько итераций подгонки и $\sigma$-отсечения. Ниже мы приводим пример интерактивной функции 
polyfit, которую вы могли бы использовать в своей функции fit_continuum.

```python
def iterative_polyfit(x,y,order=1,iterations=10,k_clip=3):
    x_to_fit = np.copy(x)
    y_to_fit = np.copy(y)
    for i in range(iterations):
        # подгонка данных
        fit = np.polyfit(x_to_fit,y_to_fit,order)
        yfit = np.polyval(fit,x_to_fit)
        # находим остатки
        residuals = y_to_fit - yfit
        sigma_residuals = np.std(residuals)
        # выявление выбросов
        subsample = np.where(np.abs(residuals)<k_clip*sigma_residuals)[0]
        # print('{} Points removed'.format(removed))
        # Установите подходящие данные такими, чтобы они имели меньшие остатки, чем 3-сигма
        x_to_fit = x_to_fit[subsample]
        y_to_fit = y_to_fit[subsample]

    return fit # Из последней итерации
```

Хорошо, теперь запустите обе функции (вашу функцию сглаживания и вашу функцию rebin/continuum) для системного
спектра и постройте график результатов.

```python
# Запустите обе функции (smooth + rebin /continuum) и постройте свой сглаженный, нормированный по 
# континууму синтетический спектр
# Сравните это с одним из ваших научных спектров.

for id in star_id:
    
    data = hdu[id].data

    lsf = 25
    synthetic_smooth = smooth_spectrum(pflux, lsf)
    model = fit_continuum(pwave, synthetic_smooth, data['OPT_WAVE'], data['OPT_COUNTS'])
    
    fig,ax = plt.subplots(figsize=(15,4))

    ax.plot(data['OPT_WAVE'], data['OPT_COUNTS'],label = 'Science')
    ax.plot(data['OPT_WAVE'], model, label='Zero Velocity Model')

    ax.set_xlabel('Wavelength (Ang)')
    ax.set_ylabel('Flux')
    ax.set_title('Star ID: {}'.format(id))

    ax.set_xlim(8300,8700)
    plt.legend()
```

![image](https://astro-330.github.io/_images/Lab5_solutions_34_0.png)
![image](https://astro-330.github.io/_images/Lab5_solutions_34_1.png)
![image](https://astro-330.github.io/_images/Lab5_solutions_34_2.png)

Итак, вышеприведенные модели соответствуют научным данным, за исключением неизвестного сдвига скорости.

_Примечание_

_Поскольку мы используем единый шаблон, он подходит к некоторым звездам (например, к глубине/ширине линии 
поглощения) лучше, чем к другим. На самом деле мы бы выбрали шаблоны для каждого запуска, которые лучше 
соответствовали бы друг другу. Но, как выясняется, даже при том, что “наилучшее соответствие” здесь не 
будет хорошим в “абсолютном” смысле (за исключением одной из трех звезд), оно все равно (в основном) правильно 
идентифицирует правильный сдвиг. Другими словами, окончательный сдвиг может быть не очень подходящим, но он 
будет лучшим, когда мы выполним поиск по сетке или mcmc._

# Экстра (1.0)
При подборе континуумов мы обычно хотим избежать “особенностей” в спектре. Мы могли бы замаскировать их 
или отбросить процентили данных далеко от медианы... но мы также могли бы итеративно удалять их. Чтобы 
сделать это, вы должны сначала подогнать выбранную вами функцию к данным, затем выполнить итерацию, отбросив 
3 (или 5, или что угодно, что работает) точки, удаленные от сигмы, и выполнить повторную подгонку. 
Это работает, потому что линии излучения и поглощения имеют точки данных, далекие от значения континуума. 
Попробуйте подогнать свой континуум таким образом, чтобы получить более точную оценку.

Смотрите сценарий выше <red>fit_continuum</red>, где я замаскировал нижние 20% и верхние 1% потоков, 
или предоставленный итеративный polyfit.

# 6. Подгонка $\chi^2$ для определения скорости

Приведенные выше научные и синтетические спектры должны примерно совпадать – за исключением неизвестного 
сдвига скорости. Вы можете изменить скорость синтетического шаблона, изменив его матрицу длин волн перед 
сглаживанием. Напомним, что $\delta\lambda = \lambda \cdot v / c$. 

Напишем код $\chi^2$, чтобы найти 
наиболее подходящую скорость для каждой из трех звезд выше. Посмотрим на скорость шарового скопления NGC 7006, 
чтобы обосновать диапазон скоростей для поиска. Учитываем разрешение по длине волны ваших научных данных, 
чтобы определить расстояние между вашей сеткой.

```python
def calc_chi2(flux, model, ivar):
    # Функция для вычисления chi2
    
    chi2 = np.sum(ivar * (flux-model)**2)
    return chi2
```

```python
# Напишите алгоритм chi2 для определения наилучшей скорости подгонки и ошибки.

v_guess  = [-400,-405,-50]    # Догадки, указанные выше
lsf = 25

for id,vg in zip(star_id,v_guess):
    
    # УСТАНОВКА СПЕКТР ДАННЫХ И ИНИЦИАЛИЗИРУЙТЕ СЕТКУ СКОРОСТЕЙ
    data = hdu[id].data
    v_grid = np.arange(-25,25,0.05) + vg 

    chi2_grid = []
    for v in v_grid:
        
        # СМЕЩЕНИЕ СИНТЕТИЧЕСКОЙ ДЛИНЫ ВОЛНЫ
        shifted_wave =   pwave * (1 + v/2.997924e5)     

        # ГЛАДКИЙ ШАБЛОН
        synthetic_smooth = smooth_spectrum(pflux, lsf)
        
        # СОВПАДЕНИЕ КОНТИНУУМА
        model            = fit_continuum(shifted_wave, synthetic_smooth, data['OPT_WAVE'], data['OPT_COUNTS'])
        
        # ВЫЧИСЛИТЕ CHI2 И ДОБАВЛЕНИЕ
        c = calc_chi2(data['OPT_COUNTS'], model, data['OPT_COUNTS_IVAR'])
        chi2_grid = np.append(chi2_grid,c)
        
        
 
    # ПОИСК ЛУЧШЕГО ЗНАЧЕНИЯ
    idx_min = np.argmin(chi2_grid)
    
    # ПОИСК ОШИБОК
    msk = chi2_grid < (np.min(chi2_grid) + 1.)
    v_err = (np.max(v_grid[msk]) - np.min(v_grid[msk]))/2.

    str = 'Пункт 6, STAR ID: {}   Velocity = {:0.1f} +/- {:0.2f} km/s'.format(id, v_grid[idx_min],v_err)
    
    fig,ax = plt.subplots(figsize=(15,4))
    plt.plot(v_grid,chi2_grid,'.')
    plt.xlabel('Velocity (km/s)')
    plt.ylabel('Chi2')    
    plt.title(str)
    plt.axvline(v_grid[idx_min],color='r')
```

![image](https://astro-330.github.io/_images/Lab5_solutions_42_0.png)
![image](https://astro-330.github.io/_images/Lab5_solutions_42_1.png)
![image](https://astro-330.github.io/_images/Lab5_solutions_42_2.png)

# 7. Подгонка $\chi^2$ с большим количеством параметров

В пункте 6 мы установили значение сглаживания на 25 пикселей и использовали единственную функцию, чтобы 
сопоставить синтетический континуум с научным. Далее давайте повторим $\chi^2$, но теперь включим эти значения 
в подгонку. Это будет подгонка по 2 параметрам chi2.

```python
# Повторить поиск подгонки $chi^2$ по 2 (и бонусным 4) параметрам:
# скорость, сглаживание и (бонус) непрерывное значение (m,b)
# Если вы используете 4 параметра, это будет некрасиво.
#
# Вычисляем ошибки из ваших контуров chi2 только по скорости.

v_guess  = [-400,-400,-50]
lsf_grid = np.arange(5,30,1)

for id,vg in zip(star_id,v_guess):
    
    # УСТАНОВИМ СПЕКТР ДАННЫХ И ИНИЦИАЛИЗИРУЕМ СЕТКУ СКОРОСТЕЙ
    data = hdu[id].data
    wmask = (data['OPT_WAVE'] > 8300) & (data['OPT_WAVE'] < 8700)

    v_grid = np.arange(-15,15,0.1) + vg 

    # ДВОЙНОЙ ЦИКЛ, МЫ ПРИШЛИ К ЭТОМУ!
    chi2_grid, v_arr, lsf_arr = [],[],[]
    for v in v_grid:
        for lsf in lsf_grid:

            # СДВИНЕМ СИНТЕТИЧСЕКУЮ ДЛИНУ ВОЛНЫ
            shifted_wave =   pwave * (1 + v/2.997924e5)     

            # СГЛАЖИВАЕМ ГРАФИК
            synthetic_smooth = smooth_spectrum(pflux, lsf)

            # СОПОСТАВЛЯЕМ КОНТИНУУМЫ
            model            = fit_continuum(shifted_wave, synthetic_smooth,\
                                             data['OPT_WAVE'][wmask], data['OPT_COUNTS'][wmask])

            # РАССЧИТЫВАЕМ CHI2 И ДОБАВЛЯЕМ
            c = calc_chi2(data['OPT_COUNTS'][wmask], model, data['OPT_COUNTS_IVAR'][wmask])
            chi2_grid = np.append(chi2_grid,c)
            v_arr   = np.append(v_arr,v)
            lsf_arr = np.append(lsf_arr,lsf)
        
    # ВЫВОДИМ CHI2 РЕЗУЛЬТАТЫ
    fig, ax = plt.subplots(figsize=(8,5))
    idx_min = np.argmin(chi2_grid)
    
    # ПОИСК ОШИБОК
    msk = chi2_grid < (np.min(chi2_grid) + 1.)
    v_err = (np.max(v_arr[msk]) - np.min(v_arr[msk]))/2.

    plt.scatter(v_arr,lsf_arr,c=chi2_grid,marker='o',s=35,\
            vmin=chi2_grid[idx_min],vmax =chi2_grid[idx_min]+1000)

    str = 'Пункт 7, STAR ID: {}   Velocity = {:0.1f} +/- {:0.2f} kms  Line Width = {} pixels'.format(id, \
                                                             v_arr[idx_min],v_err,lsf_arr[idx_min])

    plt.plot(v_arr[idx_min],lsf_arr[idx_min],'ro')
    plt.xlabel('Velocity (km/s)')
    plt.ylabel('Line Spread (pixels)')    
    plt.title(str)
```


![image](https://astro-330.github.io/_images/Lab5_solutions_45_0.png)
![image](https://astro-330.github.io/_images/Lab5_solutions_45_1.png)
![image](https://astro-330.github.io/_images/Lab5_solutions_45_2.png)

# 8. MCMC для определения скорости
Повторим пункт 7, но на этот раз в соответствии с MCMC. Мы предлагаем написать одну функцию make_model, 
которая создает единый спектр синтетической модели с учетом входной скорости и сглаживания. 
Сообщим о наиболее подходящей скорости и ошибках.

Вы можете выбрать 2 параметра (скорость и сглаживание) или в качестве бонуса все 4 параметра 
(значения скорости, сглаживания и континуума).

```python
import emcee
import corner
```

```python
# MCMC to find velocity only.  Report your best fit velocity and errors.
# Plot full corner plots for all fitted parameters.

def mk_model(theta, data_wave, data_flux, data_ivar, syn_wave, syn_flux):
    '''
    Create a model spectrum 
    
    ''' 
    # SHIFT SYNTHETIC WAVELENGTH 
    shifted_wave =   syn_wave * (1 + theta[0]/2.997924e5)     

    # SMOOTH TEMPLATE
    synthetic_smooth = smooth_spectrum(syn_flux, theta[1])

    # MATCH CONTINUUM
    model            = fit_continuum(shifted_wave, synthetic_smooth, data_wave, data_flux)
    
    return model
```

```python
def lnprob(theta, data_wave, data_flux, data_ivar, syn_wave, syn_flux):
    '''
    Evaluate whether to accept sample
    
    ''' 
    lp = lnprior(theta)

    if not np.isfinite(lp):
        return -np.inf

    return lp + lnlike(theta, data_wave, data_flux, data_ivar, syn_wave, syn_flux)



def lnprior(theta):
    '''
    Set priors on parameters
    ''' 
    if (-500 < theta[0] < 500) & (1 < theta[1] < 50):
        return 0.0
    
    return -np.inf


def lnlike(theta, data_wave, data_flux, data_ivar, syn_wave, syn_flux):
    '''
    Evaluate the log-likelihood
    
    Parameters
    ----------
    theta: float array
        Current values of fitted parameters
        
    x,y, sigma: float arrays
        Data points and one sigma errors

    Returns
    -------
    lnl
        log-likelihood value  
    ''' 
    # MAKE MODEL
    model = mk_model(theta, data_wave, data_flux, data_ivar, syn_wave, syn_flux)

    # EVALUATE LIKELIHOOD
    chi2 = ((data_flux - model)**2)*data_ivar
    lnl  = -0.5 * np.sum(chi2)
    
    return lnl


def initialize_walkers(vguess,lguess):
    '''
    Initialize the walkers using an initial guess

    ''' 
        
    # Two free parameters (m,b) and 20 walkers
    ndim, nwalkers = 2, 20
    p0 =  np.random.rand(ndim * nwalkers).reshape((nwalkers, ndim))

    # initialize slope 
    p0[:,0] = (p0[:,0]*50. - 25) + vguess
    
    
    # initialize intercept
    p0[:,1] = (p0[:,1] * 5) + lguess
    
    p0 = [np.array([vguess,lguess]) + 1e-4 * np.random.randn(ndim) for i in range(nwalkers)]

    return ndim,nwalkers,p0
```

```python
def plot_mcmc(sampler, burnin, ndim):
    
    '''
    Plot emcee sample chains and make corner plot
    ''' 
     
    fig, (ax1, ax2) = plt.subplots(1, 2,figsize=(20,5))

    for ii in range(20):
        ax1.plot(sampler.chain[ii,:,0], color="k",linewidth=0.5)

    for ii in range(20):
        ax2.plot(sampler.chain[ii,:,1], color="k",linewidth=0.5)


    ax1.set_ylabel('Velocity (km/s)')
    ax2.set_ylabel('Line Width (pixels)')
    ax1.set_xlabel('Step Number')
    ax2.set_xlabel('Step Number')

    ax1.set_title('Velocity (V) Sample chains')
    ax2.set_title('Smoothing (LSF) Sample chains')

    ax1.axvline(burnin,label='Burn-in')
    ax2.axvline(burnin)
    ax1.legend()

    # PLOT CORNER
    labels=['v','lsf']
    samples   = sampler.chain[:, burnin:, :].reshape((-1, ndim))
    fig = corner.corner(samples, labels=labels,show_titles=True,quantiles=[0.16, 0.5, 0.84])
    
   return best_v,best_v_err

```

```python
def plot_best_fit(best_v,best_lsf,data_wave,data_flux,data_ivar,starid):
    '''
    Plot best fitting model over science spectrum
    '''     
      
    template_file_name = 'dmost_lte_5000_3.0_-2.0_.fits'
    syn_wave, syn_flux = read_synthetic_spectrum(template_file_name)

    model = mk_model([best_v,best_lsf], data_wave, data_flux, data_ivar, syn_wave, syn_flux)

    fig,ax = plt.subplots(figsize=(15,4))

    ax.plot(data_wave,data_flux,label = 'Science')
    ax.plot(data_wave, model, label='Best Fit Model')

    ax.set_xlabel('Wavelength (Ang)')
    ax.set_ylabel('Flux')
    ax.set_xlim(8300,8700)
    ax.set_title('Star ID: {}'.format(starid))
    plt.legend()
```

```python
def run_mcmc(starid, vguess, lguess, hdu, max_n = 1000):
    '''
    Set up MCMC and run
    '''     
 
    data = hdu[starid].data
    data_wave = data['OPT_WAVE']

    wmask = (data_wave > 8300) & (data_wave < 8700)

    data_wave = data_wave[wmask]
    data_flux = data['OPT_COUNTS'][wmask]
    data_ivar = data['OPT_COUNTS_IVAR'][wmask]
    
    template_file_name = 'dmost_lte_5000_3.0_-2.0_.fits'
    syn_wave, syn_flux = read_synthetic_spectrum(template_file_name)

    ndim, nwalkers, p0 = initialize_walkers(vguess,lguess)

    # INITIALIZE SAMPLER
    sampler = emcee.EnsembleSampler(nwalkers, ndim, lnprob, \
                            args=(data_wave, data_flux, data_ivar, syn_wave, syn_flux))

    # RUN MCMC
    pos, prob, state = sampler.run_mcmc(p0, max_n)
    
    # CALCULATE NUMBER OF BURNIN SAMPLES
    tau    = sampler.get_autocorr_time(tol=0)
    burnin = int(2 * np.max(tau))
    print('Number of burnin samples: ',burnin)
    
    # CHECK IF THINGS CONVERGED
    converged = np.all(tau * 100 < sampler.iteration)
    print('Did chains converge [0/1:]? ', np.sum(converged))
    
    # CALCULATE BEST VALUES
    best_v     = np.mean(sampler.chain[:,burnin:,0])
    best_lsf   = np.mean(sampler.chain[:,burnin:,1])

    best_v_err = (np.percentile(sampler.chain[:,burnin:,0],84) - np.percentile(sampler.chain[:,burnin:,0],16))/2.
    print('Best velocity: {:0.2f} +/- {:0.2f} km/s'.format(best_v,best_v_err))

    # PLOT STUFF
    plot_best_fit(best_v,best_lsf,data_wave,data_flux,data_ivar, starid)
    plot_mcmc(sampler, burnin, ndim)
```

```python
star_ids  = [121,  135,  157]
v_guess   = [-400,-405,-50]
lsf_guess = [13,9,15]
```

```python
i=0
run_mcmc(star_ids[i], v_guess[i], lsf_guess[i], hdu, max_n = 2000)
```

```text
Number of burnin samples:  73
Did chains converge [0/1:]?  0
Best velocity: -402.26 +/- 0.41 km/s
```

![image](https://astro-330.github.io/_images/Lab5_solutions_55_1.png)
![image](https://astro-330.github.io/_images/Lab5_solutions_55_2.png)
![image](https://astro-330.github.io/_images/Lab5_solutions_55_3.png)

```python
i = 1
run_mcmc(star_ids[i], v_guess[i], lsf_guess[i], hdu, max_n = 2000)
```

```text
Number of burnin samples:  105
Did chains converge [0/1:]?  0
Best velocity: -405.34 +/- 0.07 km/s
```

![image](https://astro-330.github.io/_images/Lab5_solutions_56_1.png)
![image](https://astro-330.github.io/_images/Lab5_solutions_56_2.png)
![image](https://astro-330.github.io/_images/Lab5_solutions_56_3.png)

Результаты MCMC для Star 2 выглядят не очень хорошо. Это кажется очень чувствительным 
к входным значениям. Многие из вас смогли улучшить внешний вид!

```python
i = 2
run_mcmc(star_ids[i], v_guess[i], lsf_guess[i], hdu, max_n = 2000)
```

```text
Number of burnin samples:  72
Did chains converge [0/1:]?  0
Best velocity: -49.90 +/- 0.29 km/s
```

![image](https://astro-330.github.io/_images/Lab5_solutions_58_1.png)
![image](https://astro-330.github.io/_images/Lab5_solutions_58_2.png)
![image](https://astro-330.github.io/_images/Lab5_solutions_58_3.png)


_Примечание:_

_В контексте MCMC вы часто будете слышать, как люди говорят о «маргинализации». Это классический пример. 
Маргинализация — это процесс подгонки параметров, которые нас интересуют, плюс «мешающие параметры», 
которые нам не нужны (например, значения сглаживания и континуума), а затем «маргинализация» мешающих 
параметров путем взятия одномерного апостериорного разброса только параметра представляет интерес._

# 9. Конвергенция MCMC
Подтвердите, что ваш MCMC, указанный выше, сошелся, и что вы отбрасываете соответствующее количество 
сэмплов при определении ваших параметров (это число сжигания).

С 2000 образцами мой код формально не сходился, но по-прежнему обеспечивает надежные значения наилучшего 
соответствия. Однако ошибки по этим значениям менее точно определены. Если бы мне пришлось опубликовать 
эту работу, я бы запустил больше примеров, чтобы убедиться, что ошибки исправлены.

# 10. Наука
И, наконец, несколько научных вопросов:
1. Совпадают ли скорости между chi2 и mcmc в пределах погрешности? 
   **_Скорости очень хорошо согласуются между этими методами._**
2. Ошибки скорости одинаковые?
   **_Ошибки для chi2, как правило, меньше._**
3. Являются ли эти три звезды частью NGC 7006?
   **_Скорость NGC 7006 составляет -384 км/с. Звезда 1 и 2 определенно являются членами NGC 7006. 
   Звезда 3 — звезда переднего плана, скорее всего, связанная с диском Млечного Пути._**

# Бонус: организация спектров/редукция выше с использованием ООП
Вот два класса, которые довольно аккуратно делают все вышеперечисленное, с примером их использования.

```python
class Spectrum():
    def __init__(self,file,extension,wl_min=8300,wl_max=8800):
        self.ext = extension
        self.wl_min = wl_min
        self.wl_max = wl_max
        self.wave,self.flux,self.unc = self.load_and_truncate(self.ext,wl_min=wl_min,wl_max=wl_max)
        
    def load_and_truncate(self,extension,wl_min,wl_max):
        with fits.open(file) as hdu:
            h = hdu[extension].header
            d = hdu[extension].data
        m, = np.where((d['OPT_WAVE']>wl_min)&(d['OPT_WAVE']<wl_max))
        flux = d['OPT_COUNTS'][m]
        wave = d['OPT_WAVE'][m]
        unc = d['OPT_COUNTS_IVAR'][m]
        unc = np.sqrt(1./unc)
        return wave,flux,unc
    
    def plot(self,other=None):
        fig, ax = plt.subplots(figsize=(40,5))
        ax.fill_between(self.wave,self.flux-self.unc,self.flux+self.unc,color='gray',alpha=0.2)
        ax.plot(self.wave,self.flux,color='k')
        if other != None:
            if hasattr(other,'wave'):
                ax.plot(other.wave,other.flux,color='C1')
            else:
                #assume tuple x,y
                ax.plot(other[0],other[1],color='C1')
        ax.set_xlim(self.wl_min,self.wl_max)
        ax.set_xticks(np.arange(self.wl_min,self.wl_max,25))
        ax.tick_params(direction='in',top=True,right=True,length=10,labelsize=14)
        ax.set_ylabel('Flux',fontsize=15)
        ax.set_xlabel('wavelength',fontsize=15)
        return fig, ax
    def chi_squared(self,flux):
        chi2 = 0.5*np.sum((self.flux - flux)**2/self.unc**2)
        red_chi2 = chi2 / (len(self.flux)+2)
        return chi2, red_chi2
    
class FitSynthetic():
    def __init__(self,fname):
        with fits.open(fname) as hdu:
            data     = hdu[1].data
        self.flux = np.array(data['flux']).flatten()
        awave = np.exp((data['wave']).flatten())
        # CONVERTING AIR WAVELENGTHS TO VACUUM
        s = 10**4 / awave
        n = 1. + 0.00008336624212083 + \
                (0.02408926869968 / (130.1065924522 - s**2)) +\
                (0.0001599740894897 / (38.92568793293 - s**2))
        self.wave  = awave*n
    def add_spectrum(self,spec):
        self.spec = spec        
        
    def match_continuum(self,plot=False):
        synth_interp = np.interp(self.spec.wave,self.wave,self.flux)
        response_fn = synth_interp / self.spec.flux
        fit_response = iterative_polyfit(self.spec.wave,response_fn,1)
        fit_vals = np.polyval(fit_response,self.wave)
        if plot:
            fig,ax=plt.subplots(figsize=(40,5))
            ax.plot(self.spec.wave,response_fn)
            ax.plot(self.wave,fit_vals)
            ax.set_xlim(8300,8800)
        self.matched_flux = self.flux / fit_vals
    
    
    def get_model(self,velocity,sigma=25):
        '''
        Shift, Smooth, and Rebin synthetic spectrum based on a velocity and kernel
        '''
        velocity*= u.km/u.s
        new_wave = ((self.wave*u.angstrom) + (self.wave*u.angstrom)*(velocity/astro_c.c)).to(u.angstrom).value
        smoothspec = gaussian_filter1d(self.matched_flux,sigma)
        m, = np.where((new_wave>self.spec.wl_min)&(new_wave<self.spec.wl_max))
        swave = new_wave[m]
        sflux = smoothspec[m]
        rebinned = np.interp(self.spec.wave,swave,sflux)
        
        return self.spec.wave, rebinned
        
    def plot(self,wl_min,wl_max,which='raw',other=None):
        fig, ax = plt.subplots(figsize=(40,5))
        if which=='raw':
            ax.plot(self.wave,self.flux,color='k')
        elif which=='matched':
            if hasattr(self,'matched_flux'):
                ax.plot(self.wave,self.matched_flux,color='k')
            else:
                raise AttributeError('matched flux not found, try running match_continuum method.')
                
        if other != None:
            ax.plot(other.wave,other.flux,color='C1')
        ax.set_xlim(wl_min,wl_max)
        ax.set_xticks(np.arange(wl_min,wl_max,25))
        ax.tick_params(direction='in',top=True,right=True,length=10,labelsize=14)
        ax.set_ylabel('Flux',fontsize=15)
        ax.set_xlabel('wavelength',fontsize=15)
        return fig, ax
```

Вот вариант использования. Я настроил все так, чтобы класс <red>FitSynthetic</red получал объект <red>Spectrum</red>
и работал с ним:

```python
star_example = Spectrum(file,121) #initialize spectrum object for one of the stars 

fit = FitSynthetic(template_file) #initialize fit synthetic with a file
fit.add_spectrum(star_example) # add the star spec
fit.match_continuum() # match the continuum 

# I can now ask for a model with any velocity or smmoothing

x,y = fit.get_model(-400,15)

# And my Spectrum class has a handy chi2 function to compare itself to any input model 

star_example.chi_squared(y)
```

Вышеупомянутое означает, что весь код, который вам нужно написать, чтобы соответствовать скорости 
за счет минимизации chi2, выглядит следующим образом:

```python
def min_chi2(spectrum,template_file,v_grid):
    fit = FitSynthetic(template_file)
    fit.add_spectrum(spectrum)
    fit.match_continuum()
    store = []
    for v in v_grid():
        x,y = fit.get_model(v,15)
        c2,c2r = spectrum.chi_squared(y)
        store.append(c2r)
    minc2 = np.argmin(store)
    return v_grid[minc2]
```

Наконец, у каждого состояния каждого класса есть удобные методы построения (<red>plot</red>) графика для 
отображения того, что хранится.